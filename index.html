<html>
  <head>
    <title>MusicPlayer</title>

	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript">

    var webSock = new WebSocket('ws://localhost:8080/');

	var tagList = [];

	var tagCount = 0;
	var tagOffset = 0;

    function onWebSockOpen()
    {
    	alert('Connected!');
    }

    function onWebSockMessage(event)
    {
    	var data = JSON.parse(event.data);

    	switch (data.replyTo)
    	{
    	case 'getTagCount':
    		onGetTagCountReply(data);
    		break;

    	case 'getTags':
    		onGetTagsReply(data);
    		break;

    	default:
    		alert('Invalid reply data.');
    		break;
    	}
    }

    webSock.onopen = onWebSockOpen;
    webSock.onmessage = onWebSockMessage;

    function getTagCount(callback)
    {
		var query = { call: 'getTagCount' };
		sendQuery(query);
    }

    function onGetTagCountReply(data)
   	{
   		tagCount = data.tagCount;
   		getTags();
   	}

    function getTags()
	{
		var tagsRemaning = tagCount - tagOffset;
		var tagsToGet = Math.min(4, tagsRemaning);

		var query = { call: 'getTags', offset: tagOffset, tagsToGet: tagsToGet };
		sendQuery(query);
	}

	function onGetTagsReply(data)
   	{
   		tagOffset += data.tagCount;
   		tagList = tagList.concat(data.tagData);

   		if (tagOffset >= tagCount)
   		{
   			displayTags();
   			return;
   		}

   		getTags();
   	}

    function startGettingTags()
    {
		var ajax_loading = "<img src='images/loading.gif' alt='loading...' />";
		$("#result").html(ajax_loading);

		getTagCount();
    }

    function displayTags()
    {
    	var html = '';

    	for (cnt = 0; cnt < tagList.length; cnt++)
    	{
    		var tag = tagList[cnt];

    		if (!tag)
    			continue;

    		html += tag.artist + ' - ' + tag.album + ' - ' + tag.track;
    		html += '<br />';
    	} 

    	$("#result").html(html);
    }

    function sendQuery(query)
    {
    	webSock.send(JSON.stringify(query));
    }

    $(document).ready(
    	function() 
    	{
		    $("#getAllFiles").click(startGettingTags);
		});
    </script>
  </head>
  <body>
  	<input type="submit" value="Get file list" id="getAllFiles" />

  	<div id="result">
  	</div>
  </body>
</html>
